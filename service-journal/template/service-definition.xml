<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE server PUBLIC
  "-//Nimbus//DTD Nimbus 1.0//JA"
  "http://nimbus.sourceforge.jp/dtd/nimbus-service_1_0.dtd">

<server>
    
    <default-log>
        <debug output="false"/>
        <information output="false"/>
        <warning output="true"/>
        <error output="true"/>
        <fatal output="true"/>
    </default-log>
    
    <manager name="Template.Service.Journal.AccessJournal">
        
        <manager-property name="Template.Service.Journal.AccessJournal.LOG_OUTPUT_PATH">.</manager-property>
        
<!--=======================================================================
ジャーナルサービス
========================================================================-->
        <!-- アクセスジャーナル -->
        <service name="AccessJournal"
                 code="jp.ossc.nimbus.service.journal.ThreadManagedJournalService"
                 instance="template">
            <attribute name="EditorFinderName">#AccessJournalEditorFinder</attribute>
            <attribute name="WritableElementKey">Access</attribute>
            <attribute name="CategoryServiceNames">
                #AccessNormalJournalCategory
                #AccessErrorJournalCategory
            </attribute>
            <attribute name="QueueServiceName">#AccessJournalQueue</attribute>
            <depends>AccessJournalEditorFinder</depends>
            <depends>AccessNormalJournalCategory</depends>
            <depends>AccessErrorJournalCategory</depends>
            <depends>AccessJournalQueue</depends>
        </service>

        <service name="AccessJournalQueue"
                 code="jp.ossc.nimbus.service.queue.DefaultQueueService"
                 instance="template">
            <attribute name="MaxThresholdSize">1000</attribute>
        </service>
        
<!--=======================================================================
カテゴリサービス
========================================================================-->

        <service name="AccessNormalJournalCategory"
                 code="jp.ossc.nimbus.service.writer.SimpleCategoryService"
                 instance="template">
            <attribute name="MessageWriterServiceName">#AccessNormalJournalWriter</attribute>
            <attribute name="WritableRecordFactoryServiceName">#AccessNormalJournalWritableRecordFactory</attribute>
            <depends>AccessNormalJournalWriter</depends>
            <depends>AccessNormalJournalWritableRecordFactory</depends>
        </service>

        <!-- アクセスエラージャーナルカテゴリ -->
        <service name="AccessErrorJournalCategory"
                 code="jp.ossc.nimbus.service.writer.EvaluateCategoryService"
                 instance="template">
            <attribute name="WritableConditions">
                @Access.JournalRecords.Request[0].JournalRecords.Exception[0]@!=null or @Access.JournalRecords.Request[0].JournalRecords.Exchange[0].JournalRecords.Exception[0]@!=null
            </attribute>
            <attribute name="MessageWriterServiceName">#AccessErrorJournalWriter</attribute>
            <attribute name="WritableRecordFactoryServiceName">#AccessErrorJournalWritableRecordFactory</attribute>
            <depends>AccessErrorJournalWriter</depends>
            <depends>AccessErrorJournalWritableRecordFactory</depends>
        </service>


<!--=======================================================================
WritableRecordFactoryサービス
========================================================================-->
        <!-- アクセスジャーナルのフォーマッタ -->
        <service name="AccessNormalJournalWritableRecordFactory"
                 code="jp.ossc.nimbus.service.writer.PropertyWritableRecordFactoryService"
                 instance="template">
            <attribute name="FormatKeyMapping">
                DATE=Access.StartTime
                REQUEST_ID=Access.RequestID
                CLIENT_IP=Access.JournalRecords.Request[0].JournalRecords.ServletRequest[0].RemoteAddress
                SESSION_ID=Access.JournalRecords.Response[0].JournalRecords.HttpSession[0].ID
                REQUEST_URL=Access.JournalRecords.Request[0].JournalRecords.ServletRequest[0].RequestURL
                REQUEST_OBJ=Access.JournalRecords.Request[0].JournalRecords.Exchange[0].JournalRecords.Request[0].JournalRecords.{{RequestBytes[0]}|{RequestObject[0].Bytes(UTF-8)}}
                RESPONSE_STATUS=Access.JournalRecords.Response[0].JournalRecords.ServletResponse[0].Status
                RESPONSE_OBJ=Access.JournalRecords.Request[0].JournalRecords.Exchange[0].JournalRecords.Response[0].JournalRecords.ResponseBytes[0]
                PERFORMANCE=Access.Performance
            </attribute>
            <attribute name="Format">%DATE%,%REQUEST_ID%,%CLIENT_IP%,%SESSION_ID%,%REQUEST_URL%,%REQUEST_OBJ%,%RESPONSE_STATUS%,%RESPONSE_OBJ%,%PERFORMANCE%</attribute>
            <attribute name="ImplementServiceNames">
                DATE=#AccessNormalDateElement
                REQUEST_OBJ=#SimpleElement
                RESPONSE_OBJ=#SimpleElement
            </attribute>
            <depends>AccessNormalDateElement</depends>
            <depends>SimpleElement</depends>
        </service>
        
        <service name="AccessNormalDateElement"
                 code="jp.ossc.nimbus.service.writer.DateElement"
                 instance="template">
            <attribute name="Format">yyyy/MM/dd HH:mm:ss.SSS</attribute>
        </service>
        
        <service name="SimpleElement"
                 code="jp.ossc.nimbus.service.writer.SimpleElement" 
                 instance="template"/>
        
        <!-- アクセスエラージャーナルのフォーマッタ -->
        <service name="AccessErrorJournalWritableRecordFactory"
                 code="jp.ossc.nimbus.service.writer.PropertyWritableRecordFactoryService"
                 instance="template">
            <attribute name="FormatKeyMapping">
                DATE=Access.StartTime
                REQUEST_ID=Access.RequestID
                CLIENT_IP=Access.JournalRecords.Request[0].JournalRecords.ServletRequest[0].RemoteAddress
                SESSION_ID=Access.JournalRecords.Response[0].JournalRecords.HttpSession[0].ID
                REQUEST_URL=Access.JournalRecords.Request[0].JournalRecords.ServletRequest[0].RequestURL
                REQUEST_OBJ=Access.JournalRecords.Request[0].JournalRecords.Exchange[0].JournalRecords.Request[0].JournalRecords.{{RequestBytes[0]}|{RequestObject[0].Bytes(UTF-8)}}
                RESPONSE_STATUS=Access.JournalRecords.Response[0].JournalRecords.ServletResponse[0].Status
                PERFORMANCE=Access.Performance
                RESPONSE_OBJ=Access.JournalRecords.Request[0].JournalRecords.Exchange[0].JournalRecords.Response[0].JournalRecords.ResponseBytes[0]
                EXCEPTION=Access.JournalRecords.Request[0].JournalRecords.{{Exception[0]}|{Exchange[0].JournalRecords.Exception[0]}}
            </attribute>
            <attribute name="Format">時刻=%DATE%${line.separator}リクエスト通番=%REQUEST_ID%${line.separator}クライアントIP=%CLIENT_IP%${line.separator}セッションID=%SESSION_ID%${line.separator}リクエストURL=%REQUEST_URL%${line.separator}リクエストオブジェクト=%REQUEST_OBJ%${line.separator}HTTPステータス=%RESPONSE_STATUS%${line.separator}レスポンス=%RESPONSE_OBJ%${line.separator}処理時間=%PERFORMANCE%${line.separator}発生例外=%EXCEPTION%</attribute>
            <attribute name="ImplementServiceNames">
                DATE=#AccessErrorDateElement
                REQUEST_OBJ=#ErrorSimpleElement
                RESPONSE_OBJ=#ErrorSimpleElement
            </attribute>
            <depends>AccessErrorDateElement</depends>
            <depends>ErrorSimpleElement</depends>
        </service>

        <service name="AccessErrorDateElement"
                 code="jp.ossc.nimbus.service.writer.DateElement"
                 instance="template">
            <attribute name="Format">yyyyMMddHHmmssSSS</attribute>
        </service>

        <service name="ErrorSimpleElement"
                 code="jp.ossc.nimbus.service.writer.SimpleElement"
                 instance="template"/>

<!--=======================================================================
ライターサービス
========================================================================-->
        <!-- アクセスジャーナル書き込みサービス -->
        <service name="AccessNormalJournalWriter"
                 code="jp.ossc.nimbus.service.writer.log4j.CustomizedRollingFileAppenderWriterService"
                 instance="template">
            <attribute name="Append">true</attribute>
            <attribute name="BufferedIO">false</attribute>
            <attribute name="File">${Template.Service.Journal.AccessJournal.LOG_OUTPUT_PATH}/accessjournal_%INDEX%.log</attribute>
            <attribute name="ImmediateFlush">true</attribute>
            <attribute name="Header"></attribute>
            <attribute name="MaximumFileSize">10485760</attribute>
            <attribute name="MaxBackupIndex">100</attribute>
        </service>

        <!-- アクセスエラージャーナル書き込みサービス -->
        <service name="AccessErrorJournalWriter"
                 code="jp.ossc.nimbus.service.writer.OneWriteFileMessageWriterService"
                 instance="template">
            <attribute name="File">${Template.Service.Journal.AccessJournal.LOG_OUTPUT_PATH}/error-journal/accessjournal-error</attribute>
            <attribute name="FilePostfix">_%DATE%_%REQUEST_ID%.log</attribute>
        </service>


<!--=======================================================================
EditorFinderサービス
========================================================================-->

        <!-- アクセスジャーナルに必要な型に対応するJournalEditorサービスを検索するEditorFinderサービス -->
        <service name="AccessJournalEditorFinder"
                 code="jp.ossc.nimbus.service.journal.editorfinder.ObjectMappedEditorFinderService"
                 instance="template">
            <attribute name="EditorProperties">
                java.lang.Object=#ObjectJournalEditor
                [Ljava.lang.String;=#ObjectArrayJournalEditor
                java.lang.Throwable=#ThrowableJournalEditor
                javax.servlet.http.HttpServletRequest=#HttpServletRequestJournalEditor
                javax.servlet.http.HttpServletResponse=#ServletResponseJournalEditor
                javax.servlet.http.HttpSession=#HttpSessionMapJournalEditor
                jp.ossc.nimbus.service.journal.RequestJournal=#AccessRequestJournalEditor
                byte[]=#ByteArrayJournalEditor
            </attribute>
            <depends>ObjectJournalEditor</depends>
            <depends>ObjectArrayJournalEditor</depends>
            <depends>ThrowableJournalEditor</depends>
            <depends>HttpServletRequestJournalEditor</depends>
            <depends>HttpSessionMapJournalEditor</depends>
            <depends>ServletResponseJournalEditor</depends>
            <depends>AccessRequestJournalEditor</depends>
            <depends>ByteArrayJournalEditor</depends>
        </service>


<!--=======================================================================
Editorサービス
========================================================================-->
        <!-- ジャーナルに出力するオブジェクトをジャーナル文字列へと変換するJournalEditorサービス群 -->
        <service name="AccessRequestJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.SimpleRequestMapJournalEditorService"
                 instance="template">
            <attribute name="OutputRequestId">true</attribute>
            <attribute name="OutputStartTime">true</attribute>
            <attribute name="OutputRecords">true</attribute>
            <attribute name="OutputEndTime">false</attribute>
            <attribute name="OutputPerformance">true</attribute>
        </service>

        <service name="ObjectJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.MutableObjectJournalEditorService"
                 instance="template"/>

        <service name="ObjectArrayJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.ObjectArrayJournalEditorService"
                 instance="template"/>

        <service name="ByteArrayJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.ByteArrayJournalEditorService"
                 instance="template">
            <attribute name="ConvertMode">UTF-8</attribute>
        </service>

        <service name="HttpServletRequestJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.HttpServletRequestMapJournalEditorService"
                 instance="template">
            <attribute name="OutputRemoteAddress">true</attribute>
            <attribute name="OutputRemotePort">false</attribute>
            <attribute name="OutputRemoteHost">false</attribute>
            <attribute name="OutputLocalAddress">false</attribute>
            <attribute name="OutputLocalPort">false</attribute>
            <attribute name="OutputLocalName">false</attribute>
            <attribute name="OutputServerName">false</attribute>
            <attribute name="OutputServerPort">false</attribute>
            <attribute name="OutputProtocol">false</attribute>
            <attribute name="OutputScheme">false</attribute>
            <attribute name="OutputLocale">false</attribute>
            <attribute name="OutputContentType">false</attribute>
            <attribute name="OutputContentLength">false</attribute>
            <attribute name="OutputCharacterEncoding">false</attribute>
            <attribute name="OutputAttributes">false</attribute>
            <attribute name="SecretAttributes"></attribute>
            <attribute name="EnabledAttributes"></attribute>
            <attribute name="OutputParameters">true</attribute>
            <attribute name="SecretParameters"></attribute>
            <attribute name="EnabledParameters"></attribute>
            <attribute name="OutputRequestURL">true</attribute>
            <attribute name="OutputRequestURI">false</attribute>
            <attribute name="OutputServletPath">false</attribute>
            <attribute name="OutputContextPath">false</attribute>
            <attribute name="OutputPathInfo">false</attribute>
            <attribute name="OutputPathTranslated">false</attribute>
            <attribute name="OutputQueryString">false</attribute>
            <attribute name="OutputSessionID">true</attribute>
            <attribute name="OutputIsRequestedSessionIdFromCookie">true</attribute>
            <attribute name="OutputIsRequestedSessionIdFromURL">false</attribute>
            <attribute name="OutputMethod">false</attribute>
            <attribute name="OutputAuthType">false</attribute>
            <attribute name="OutputRemoteUser">false</attribute>
            <attribute name="OutputUserPrincipal">false</attribute>
            <attribute name="OutputHeaders">false</attribute>
            <attribute name="SecretHeaders"></attribute>
            <attribute name="EnabledHeaders"></attribute>
            <attribute name="OutputCookies">false</attribute>
            <attribute name="SecretCookies"></attribute>
            <attribute name="EnabledCookies"></attribute>
        </service>

        <service name="ServletResponseJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.HttpServletResponseWrapperMapJournalEditorService"
                 instance="template">
            <attribute name="OutputBufferSize">false</attribute>
            <attribute name="OutputCharacterEncoding">false</attribute>
            <attribute name="OutputContentType">false</attribute>
            <attribute name="OutputLocale">false</attribute>
            <attribute name="OutputIsCommitted">false</attribute>
            <attribute name="OutputContentLength">false</attribute>
            <attribute name="OutputContent">true</attribute>
            <attribute name="OutputHeaders">false</attribute>
            <attribute name="OutputCookies">false</attribute>
            <attribute name="OutputStatus">true</attribute>
            <attribute name="OutputStatusMessage">false</attribute>
            <attribute name="OutputIsSentError">false</attribute>
            <attribute name="OutputRedirectLocation">false</attribute>
            <attribute name="SecretHeaders"></attribute>
            <attribute name="EnabledHeaders"></attribute>
            <attribute name="SecretCookies"></attribute>
            <attribute name="EnabledCookies"></attribute>
        </service>

        <service name="HttpSessionMapJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.HttpSessionMapJournalEditorService"
                 instance="template">
            <attribute name="OutputId">true</attribute>
            <attribute name="OutputCreationTime">false</attribute>
            <attribute name="OutputLastAccessedTime">false</attribute>
            <attribute name="OutputMaxInactiveInterval">false</attribute>
            <attribute name="OutputAttributes">true</attribute>
            <attribute name="OutputIsNew">false</attribute>
        </service>

        <service name="ThrowableJournalEditor"
                 code="jp.ossc.nimbus.service.journal.editor.ThrowableJournalEditorService"
                 instance="template"/>

    </manager>
</server>